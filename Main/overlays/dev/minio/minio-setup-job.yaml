apiVersion: batch/v1
kind: Job
metadata:
  name: minio-setup
  namespace: system-namespace
spec:
  template:
    spec:
      containers:
      - name: mc
        image: minio/mc:latest
        command: ["/bin/sh", "-c"]
        args:
        - |
          # Configure MinIO client
          mc alias set myminio http://minio:9000 "$MINIO_ROOT_USER" "$MINIO_ROOT_PASSWORD"
          
          # Wait for MinIO to be ready
          echo "Waiting for MinIO to be ready..."
          until mc admin info myminio; do
            sleep 2
          done
          
          # Create a bucket
          mc mb --ignore-existing myminio/app-data
          
          # Create user for data-service
          mc admin user add myminio "$DATA_SERVICE_USER" "$DATA_SERVICE_PASSWORD" || echo "User already exists"
          
          # Create policy for data-service
          echo '{
            "Version": "2012-10-17",
            "Statement": [
              {
                "Effect": "Allow",
                "Action": ["s3:*"],
                "Resource": ["arn:aws:s3:::app-data/*"]
              }
            ]
          }' > /tmp/data-service-policy.json
          
          mc admin policy add myminio data-service-policy /tmp/data-service-policy.json || echo "Policy already exists"
          
          # Apply policy to data-service user
          mc admin policy set myminio data-service-policy user="$DATA_SERVICE_USER"
          
          echo "MinIO setup completed"
        env:
        - name: MINIO_ROOT_USER
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: accesskey
        - name: MINIO_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: secretkey
        - name: DATA_SERVICE_USER
          valueFrom:
            secretKeyRef:
              name: data-service-minio-creds
              key: accesskey
        - name: DATA_SERVICE_PASSWORD
          valueFrom:
            secretKeyRef:
              name: data-service-minio-creds
              key: secretkey
      restartPolicy: OnFailure